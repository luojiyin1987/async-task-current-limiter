{"version":3,"file":"index.js","sources":["../src/promisedefer.ts","../src/createlimiter.ts","../src/index.ts"],"sourcesContent":["export default function promisedefer() {\n    let resolve: (value?: any) => void = (value?: any) => void 0;\n    let reject: (reason?: any) => void = (reason?: any) => void 0;\n    const promise = new Promise((res, rej) => {\n        resolve = res;\n        reject = rej;\n    });\n    return { promise, reject, resolve };\n}\n","type FUNRETPRO<T> = (...arg: any[]) => Promise<T>;\n\nexport type 空闲状态 = \"free\" | \"full\";\n\ninterface FUNANDARGS<T, S extends FUNRETPRO<T>> extends Array<any> {\n    0: S;\n    1: Parameters<S>;\n    length: 2;\n}\nimport createeventtarget, {\n    EventEmitterTarget\n} from \"@masx200/event-emitter-target\";\nimport promisedefer from \"./promisedefer\";\nimport { AsyncCurrentLimiter } from \"./AsyncCurrentLimiter\";\n// import { FUNANDARGS, FUNRETPRO, 空闲状态 } from './index';\nexport function createlimiter(max: number): AsyncCurrentLimiter {\n    if (!(typeof max === \"number\" && max > 0 && Infinity > max)) {\n        throw TypeError(\" MAX expected: number;but invalid:\" + max);\n    }\n    const 同时读取的最大文件数 = max;\n    const cachepromise = new Map<number, ReturnType<typeof promisedefer>>();\n    // const cachesymbol = new Map<string, symbol>();\n    // const getsymbolcached = (name: string) => {\n    //     const cached = cachesymbol.get(name);\n    //     if (cached) {\n    //         return cached;\n    //     }\n    //     else {\n    //         const s = Symbol(name);\n    //         cachesymbol.set(name, s);\n    //         return s;\n    //     }\n    // };\n    let pointer = 0;\n    let 当前同时读取的文件数 = 0;\n    const target: EventEmitterTarget = createeventtarget();\n    const queue: (undefined | FUNANDARGS<any, any>)[] = [];\n    let shouldrun = true;\n    target.on(\"free\", () => {\n        shouldrun = true;\n        next();\n    });\n    target.on(\"full\", () => {\n        shouldrun = false;\n    });\n    function next() {\n        const index = pointer;\n        if (!shouldrun) {\n            return;\n        }\n        if (index >= queue.length) {\n            shouldrun = false;\n            return;\n        }\n        if (status() === \"full\") {\n            shouldrun = false;\n            return;\n        }\n        incre();\n        const funargs = queue[index];\n        if (!funargs) {\n            throw Error();\n        }\n        const [fun, args] = funargs;\n        const promise = Promise.resolve(Reflect.apply(fun, undefined, args));\n        const settle = () => {\n            // target.emit(getsymbolcached(\"settle\" + index), promise);\n            const defer = cachepromise.get(index);\n            if (defer) {\n                defer.resolve(promise);\n            } else {\n                throw new Error();\n            }\n            decre();\n            /* 内存垃圾回收 */\n            queue[index] = undefined;\n        };\n        promise.then(settle, settle);\n        pointer++;\n        Promise.resolve().then(() => {\n            next();\n        });\n    }\n    function add<T, S extends FUNRETPRO<T>>(\n        funargs: FUNANDARGS<T, S>\n    ): Promise<T> {\n        let index = queue.length;\n        queue.push(funargs);\n        if (status() === \"free\") {\n            shouldrun = true;\n            next();\n        }\n        const defer = promisedefer();\n        cachepromise.set(index, defer);\n        return Promise.resolve(defer.promise) as Promise<T>;\n        /*  return new Promise<T>(res => {\n            target.once(\n                getsymbolcached(\"settle\" + index),\n                (settledpromise: Promise<T>) => {\n                    res(settledpromise);\n                }\n            );\n        }); */\n    }\n    function status(): 空闲状态 {\n        return 当前同时读取的文件数 < 同时读取的最大文件数 ? \"free\" : \"full\";\n    }\n    const asyncwrap = function<T extends (...args: any[]) => Promise<any>>(\n        fun: T\n    ): T {\n        return async function(...args: Parameters<T>) {\n            return await add([fun, args]);\n        } as T;\n    };\n    const 文件读取队列 = {\n        [Symbol.toStringTag]: \"AsyncCurrentLimiter\",\n        // add,\n        asyncwrap,\n        status,\n        limiter: {\n            get max() {\n                return 同时读取的最大文件数;\n            },\n            get current() {\n                return 当前同时读取的文件数;\n            }\n        },\n        queue: {\n            get max() {\n                return queue.length;\n            },\n            get current() {\n                return pointer;\n            }\n        },\n        target\n    };\n    function decre() {\n        if (当前同时读取的文件数 - 1 < 0) {\n            throw Error();\n        }\n        当前同时读取的文件数--;\n        dispatchstatus();\n    }\n    function dispatchstatus() {\n        const { queue, limiter } = 文件读取队列;\n        const data = {\n            status: status(),\n            queue: { max: queue.max, current: queue.current },\n            limiter: { max: limiter.max, current: limiter.current }\n        };\n        if (当前同时读取的文件数 >= 同时读取的最大文件数) {\n            target.emit(\"full\", data);\n        } else {\n            target.emit(\"free\", data);\n        }\n    }\n    function incre() {\n        if (当前同时读取的文件数 < 同时读取的最大文件数) {\n            当前同时读取的文件数++;\n            dispatchstatus();\n        } else {\n            throw Error();\n        }\n    }\n    return 文件读取队列;\n}\n","import { EventEmitterTarget } from \"@masx200/event-emitter-target\";\r\nimport { AsyncCurrentLimiter } from \"./AsyncCurrentLimiter\";\r\nimport { createlimiter } from \"./createlimiter\";\r\nimport { statusdata } from \"./status-event\";\r\n\r\ninterface Constructor<T extends (...args: any[]) => any> {\r\n    new (...args: Parameters<T>): ReturnType<T>;\r\n    (...args: Parameters<T>): ReturnType<T>;\r\n}\r\nexport type AsyncLimiterConstructor = Constructor<typeof createlimiter>;\r\nexport { AsyncCurrentLimiter };\r\nexport { statusdata };\r\nexport default (() => {\r\n    /* 检测是否支持async函数 */\r\n    new Function(\"return async()=>{}\")()();\r\n\r\n    function AsyncLimiterClass(this: any, max: number) {\r\n        const asynclimiter = createlimiter(max);\r\n        if (this && this instanceof AsyncLimiterClass) {\r\n            Object.assign(this, asynclimiter);\r\n            return this as EventEmitterTarget;\r\n        } else {\r\n            return asynclimiter;\r\n        }\r\n    }\r\n    return AsyncLimiterClass as AsyncLimiterConstructor;\r\n})();\r\n"],"names":["createeventtarget"],"mappings":"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"}